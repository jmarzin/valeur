%p#notice= notice

%h2 Saisie/modification des coûts directs d'investissement de l'étude  #{@etude._id} du projet #{@etude.projet.nom}
= form_for @direct, :url => direct_path(@etude) do |dir_form|
  %header
    = dir_form.submit 'Actualiser'
    \
    = dir_form.submit 'Enregistrer'
  %br
  %br
  %article#detail
    %table#detail
      %tr
        %th{:colspan => 3} Actions
        %th.description Description du coût
        %th.nature Nature
        %th.totaux --Totaux--
        - @etude.liste_annees.each do |annee|
          %th=annee
      -i=1
      -@direct.details.each do |detail|
        = dir_form.fields_for :details,detail do |detail_form|
          %tr{:id => [i]}
            %td= dir_form.submit 'Del', :class => 'action', :name => "d#{i}"
            %td= dir_form.submit 'Ins^', :class => 'action', :name => "h#{i}"
            %td= dir_form.submit 'Insv', :class => 'action', :name => "b#{i}"
            %td.description= detail_form.text_field :description,:size => 20
            %td.nature= detail_form.select :nature,Etude.liste_natures_directs,:size => 10
            %td.totaux.montant= number_with_precision(detail.total, options =  {delimiter: " ", precision: 0}) unless detail.total == 0
            -detail.montants.each do |montant|
              = detail_form.fields_for :montants,montant do |montant_form|
                %td.montant= montant_form.number_field :montant,:value => number_with_precision(montant.montant,options={precision: 0}), :size => 1
          -i+=1
      %tr.totaux
        %td.touche
        %td.touche
        %td.touche
        %td.description= @direct.calculees[0].description
        %td
        %td.montant=number_with_precision(@direct.total, options =  {delimiter: " ", precision: 0}) unless @direct.total == nil || @direct.total == 0
        -@direct.calculees[0].montants.each do |montant|
          %td.montant= number_with_precision(montant.montant, options =  {delimiter: " ", precision: 0}) unless montant.montant == 0

  %br
  %br
  %article#somme
    %table#somme
      %tr
        %th.nature Coûts directs pluriannuels 
        %th.montant (k€)
        %th.commentaire Commentaires
      - @direct.sommes.each do |somme|
        = dir_form.fields_for :sommes,somme do |somme_form|
          %tr
            %td.nature= somme.nature
            %td.montant= number_with_precision(somme.montant, options = {delimiter: " ", precision: 0}) unless somme.montant == 0
            %td.commentaire= somme_form.text_field :commentaire,:size => 40

  %footer
    = dir_form.submit 'Actualiser'
    \
    = dir_form.submit 'Enregistrer'

